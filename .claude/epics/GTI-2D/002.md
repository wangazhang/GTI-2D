---
name: 后端架构搭建
epic: GTI-2D
status: pending
created: 2025-09-30T02:30:00Z
dependencies: []
parallel: true
effort: M
hours: 16
task_type: infrastructure
priority: high
---

# Task 002: 后端架构搭建

## 描述

搭建Node.js + Go微服务后端架构，建立GTI-2D游戏的完整服务端基础设施。包括微服务框架搭建、数据库连接配置、API路由结构设计和基础中间件开发，为实时对战游戏提供高性能、可扩展的后端支撑。

## 验收标准

### 服务架构完成
- [ ] Node.js接入层服务框架搭建
- [ ] Go游戏逻辑微服务架构建立
- [ ] 服务间通信机制配置完成
- [ ] API网关和路由结构建立

### 数据库配置
- [ ] Redis集群连接配置完成
- [ ] MySQL数据库连接和基础表结构
- [ ] 数据库连接池和优化配置
- [ ] 数据持久化策略验证

### 基础服务验证
- [ ] 健康检查接口正常
- [ ] 基础CRUD API接口测试通过
- [ ] 服务监控和日志系统配置
- [ ] 开发环境容器化部署验证

## 技术要点

### Node.js接入层架构
```typescript
// 技术栈配置
- 框架: Express.js + TypeScript
- 通信: Socket.io for WebSocket
- 验证: JWT + Redis Session
- 中间件: CORS, Rate Limiting, Logging
```

### Go微服务架构
```go
// 服务架构设计
- 框架: Gin + gRPC
- 数据库: GORM + Redis
- 配置: Viper + 环境变量
- 监控: Prometheus + 日志中心
```

### 数据库设计
```sql
-- 核心数据表结构
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    wx_openid VARCHAR(64) UNIQUE,
    nickname VARCHAR(50),
    avatar_url TEXT,
    level INT DEFAULT 1,
    experience BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE game_rooms (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    room_code VARCHAR(10) UNIQUE,
    max_players INT DEFAULT 9,
    current_players INT DEFAULT 0,
    status ENUM('waiting', 'playing', 'finished'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_equipment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    equipment_type VARCHAR(20),
    equipment_data JSON,
    quantity INT DEFAULT 1,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 微服务通信
```yaml
# 服务发现和通信配置
services:
  api-gateway:
    port: 3000
    routes: ["/api/v1/*"]

  game-logic:
    port: 8080
    protocol: gRPC

  user-service:
    port: 8081
    protocol: HTTP + gRPC
```

## 依赖

- **外部依赖**: 无
- **基础设施**: Redis服务器、MySQL数据库
- **团队依赖**: 无

## 并行性

- **并行**: true
- **理由**: 与前端环境搭建完全独立，可同时进行

## 工作量

- **规模**: M (Medium)
- **预估时间**: 16小时
- **复杂度**: 中等
- **风险等级**: 中

## 实施步骤

### Step 1: Node.js接入层 (6小时)
1. 项目初始化和依赖安装
2. Express.js框架配置
3. TypeScript环境配置
4. 基础中间件开发
5. Socket.io集成准备
6. 基础API路由结构

### Step 2: Go微服务架构 (6小时)
1. Go项目结构建立
2. Gin框架和gRPC配置
3. 数据库连接和ORM配置
4. 基础领域模型设计
5. 服务间通信接口定义
6. 基础业务逻辑框架

### Step 3: 数据库配置 (3小时)
1. MySQL数据库设计和建表
2. Redis连接配置和数据结构设计
3. 数据库连接池优化
4. 基础数据访问层开发
5. 数据迁移脚本编写

### Step 4: 集成测试 (1小时)
1. 服务启动和健康检查
2. 数据库连接验证
3. API接口基础测试
4. 服务间通信测试

## 关键产出

### Node.js接入层
- `gti-2d-api/` - API网关服务
- `src/routes/` - 路由配置
- `src/middleware/` - 中间件模块
- `src/socket/` - Socket.io基础框架

### Go微服务
- `gti-2d-game-service/` - 游戏逻辑服务
- `gti-2d-user-service/` - 用户数据服务
- `internal/models/` - 数据模型
- `internal/handlers/` - 业务处理器

### 配置文件
- `docker-compose.yml` - 容器化配置
- `config/database.sql` - 数据库初始化脚本
- `.env.example` - 环境变量模板

## 服务架构设计

### API网关服务 (Node.js)
```typescript
// 服务职责
- HTTP/WebSocket请求路由
- 用户认证和授权
- 请求限流和安全过滤
- 静态资源服务
- 与前端Socket.io通信
```

### 游戏逻辑服务 (Go)
```go
// 服务职责
- 战斗计算和物理模拟
- AI敌人行为逻辑
- 房间状态管理
- 装备掉落算法
- 实时状态同步
```

### 用户数据服务 (Go)
```go
// 服务职责
- 用户信息管理
- 装备库存管理
- 好友关系维护
- 战绩统计分析
- 微信数据同步
```

## 验证方式

### 服务健康检查
```bash
# Node.js API网关
curl http://localhost:3000/health

# Go游戏逻辑服务
curl http://localhost:8080/health

# Go用户数据服务
curl http://localhost:8081/health
```

### 数据库连接验证
```bash
# MySQL连接测试
npm run db:test

# Redis连接测试
npm run redis:test
```

### API接口测试
```bash
# 基础用户API
curl -X POST http://localhost:3000/api/v1/users/register
curl -X GET http://localhost:3000/api/v1/users/profile

# 房间管理API
curl -X POST http://localhost:3000/api/v1/rooms/create
curl -X GET http://localhost:3000/api/v1/rooms/list
```

## 风险与缓解

### 技术风险
- **微服务复杂性**: 采用渐进式架构，先建立单体再分离
- **数据一致性**: 使用事务和分布式锁机制
- **服务发现**: 使用Docker Compose简化开发环境

### 性能风险
- **数据库性能**: 建立合理索引和查询优化
- **内存使用**: 配置连接池大小和缓存策略
- **网络延迟**: 服务间通信优化和负载均衡

### 缓解策略
- 建立完整的监控和日志系统
- 使用熔断器模式处理服务故障
- 准备服务降级和备份方案

## 性能基准

### 服务响应时间
- API网关响应: < 50ms (95%分位)
- 数据库查询: < 20ms (平均)
- 服务间通信: < 10ms (内网)

### 并发处理能力
- 同时在线用户: 1000+
- 并发房间数: 100+
- 数据库连接数: 50+

## 后续任务

完成后解锁：
- 003.md - 网络通信系统（需要后端服务基础）
- 用户认证系统任务（需要用户服务）
- 房间管理系统任务（需要游戏服务）

## 质量标准

- 代码覆盖率: 服务逻辑 > 70%
- API响应时间: < 100ms (99%分位)
- 服务可用性: > 99%
- 错误处理: 100%覆盖关键路径