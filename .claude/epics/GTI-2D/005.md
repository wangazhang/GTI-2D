---
name: 战斗和射击系统
epic: GTI-2D
status: backlog
created: 2025-09-30T02:30:00Z
dependencies: [004]
parallel: false
effort: L
hours: 24
---

# 任务005: 战斗和射击系统

## 描述

实现GTI-2D游戏的核心战斗机制，包括射击检测、伤害计算、武器系统和弹道模拟。构建流畅的射击体验，支持多种武器类型，确保战斗反馈及时准确，为玩家提供紧张刺激的对战体验。

## 验收标准

### 核心功能
- [ ] **射击检测系统**
  - 射线检测实现精确命中判定
  - 支持不同武器的射程和精度配置
  - 多目标同时命中检测
  - 射击遮挡物和穿透逻辑

- [ ] **伤害计算系统**
  - 基础伤害值计算（武器基础伤害）
  - 距离衰减伤害模型
  - 护甲减伤计算
  - 暴击伤害和随机浮动

- [ ] **武器系统**
  - 多种武器类型支持（步枪、手枪、霰弹枪等）
  - 武器属性配置（伤害、射程、射速、精度）
  - 弹药系统（弹夹容量、换弹时间）
  - 武器后坐力和散布模拟

- [ ] **弹道计算**
  - 2D弹道轨迹计算
  - 子弹飞行时间模拟
  - 弹道可视化效果
  - 网络同步优化

### 质量要求
- [ ] **性能标准**
  - 射击检测延迟 < 30ms
  - 同时支持50+子弹对象
  - 内存占用 < 80MB（战斗模块）
  - 帧率稳定 ≥ 30FPS

- [ ] **用户体验**
  - 射击反馈及时准确
  - 武器手感差异明显
  - 伤害数值显示清晰
  - 音效和特效同步

## 技术要点

### ECS组件设计
```typescript
// 武器组件
interface WeaponComponent {
  weaponType: WeaponType;
  damage: number;
  range: number;
  fireRate: number;
  accuracy: number;
  ammoCapacity: number;
  currentAmmo: number;
  reloadTime: number;
}

// 射击组件
interface ShootingComponent {
  isShooting: boolean;
  lastShotTime: number;
  targetDirection: Vec2;
  recoilPattern: Vec2[];
  currentRecoil: number;
}

// 生命值组件
interface HealthComponent {
  maxHealth: number;
  currentHealth: number;
  armor: number;
  damageReduction: number;
  isAlive: boolean;
}
```

### 核心系统实现
1. **WeaponSystem**: 处理武器逻辑和属性
2. **ShootingSystem**: 处理射击检测和弹道
3. **DamageSystem**: 处理伤害计算和应用
4. **EffectSystem**: 处理战斗特效和音效

### 射线检测算法
- 使用Cocos Creator物理射线检测
- 实现高效的批量射线检测
- 支持射线穿透和反弹
- 碰撞层级管理和过滤

### 网络同步策略
- 客户端射击预测
- 服务端权威验证
- 延迟补偿算法
- 反作弊检测机制

## 依赖关系

### 前置依赖
- **[004] 角色控制和移动系统**: 需要角色位置和朝向信息

### 提供接口
- 武器数据配置接口
- 伤害事件通知接口
- 射击状态同步接口
- 战斗统计数据接口

## 实现计划

### 第一阶段：基础射击 (8小时)
- [ ] 射线检测实现
- [ ] 基础伤害计算
- [ ] 简单武器系统
- [ ] 射击动画和特效

### 第二阶段：武器系统 (8小时)
- [ ] 多武器类型支持
- [ ] 弹药和换弹系统
- [ ] 武器属性配置
- [ ] 后坐力和散布模拟

### 第三阶段：优化完善 (8小时)
- [ ] 网络同步优化
- [ ] 性能优化
- [ ] 反作弊机制
- [ ] 战斗数据统计

## 武器配置规范

### 武器类型定义
```typescript
enum WeaponType {
  RIFLE = "rifle",           // 步枪：高精度，中等伤害
  PISTOL = "pistol",         // 手枪：快射速，低伤害
  SHOTGUN = "shotgun",       // 霰弹枪：近距离高伤害
  SNIPER = "sniper",         // 狙击枪：高伤害，低射速
  SMG = "smg"                // 冲锋枪：高射速，中等精度
}
```

### 武器平衡性配置
- **步枪**: 伤害35-45, 射程300-400, 射速300-400RPM
- **手枪**: 伤害25-35, 射程150-200, 射速500-600RPM
- **霰弹枪**: 伤害60-80, 射程80-120, 射速120-180RPM
- **狙击枪**: 伤害80-120, 射程500-600, 射速60-100RPM
- **冲锋枪**: 伤害20-30, 射程200-250, 射速600-800RPM

## 测试策略

### 功能测试
- [ ] 射击精度测试
- [ ] 伤害计算验证
- [ ] 武器切换测试
- [ ] 弹药系统测试

### 性能测试
- [ ] 大量子弹并发测试
- [ ] 射击检测性能测试
- [ ] 内存使用监控
- [ ] 网络同步压力测试

### 平衡性测试
- [ ] 武器伤害平衡验证
- [ ] 射程和精度调优
- [ ] 战斗节奏测试
- [ ] 用户体验评估

## 伤害计算公式

### 基础伤害公式
```
最终伤害 = (基础伤害 × 距离系数 × 随机系数) - 护甲减伤
```

### 距离衰减模型
```typescript
function calculateDistanceDamage(baseDamage: number, distance: number, maxRange: number): number {
  const effectiveRange = maxRange * 0.7; // 有效射程
  if (distance <= effectiveRange) {
    return baseDamage; // 有效射程内无衰减
  } else {
    const falloffFactor = Math.max(0.3, 1 - (distance - effectiveRange) / (maxRange - effectiveRange));
    return baseDamage * falloffFactor;
  }
}
```

### 护甲减伤计算
```typescript
function calculateArmorReduction(damage: number, armor: number): number {
  const reductionRate = armor / (armor + 100); // 递减收益
  return damage * (1 - reductionRate);
}
```

## 风险评估

### 技术风险
- **射击检测精度**: 中等风险
  - 缓解：完善的物理射线检测，多重验证
- **网络同步延迟**: 高风险
  - 缓解：客户端预测+服务端验证，延迟补偿

### 平衡性风险
- **武器平衡**: 中等风险
  - 缓解：数据驱动配置，快速调优能力

## 成功指标

### 技术指标
- 射击检测准确率 > 99.5%
- 射击延迟 < 30ms
- 同时支持50+子弹无性能问题
- 网络同步准确率 > 98%

### 游戏体验指标
- 武器手感差异明显
- 伤害反馈及时准确
- 战斗节奏紧张刺激
- 无明显作弊现象

## 反作弊策略

### 客户端检测
- 射击频率限制检查
- 命中率异常检测
- 伤害数值范围验证
- 射击角度合理性检查

### 服务端验证
- 所有伤害服务端计算
- 射击时间戳验证
- 距离和角度服务端校验
- 统计数据异常监控

## 相关文档

- [GTI-2D Epic概述](./epic.md)
- [角色控制和移动系统](./004.md)
- [装备和道具系统](./006.md)
- [AI敌人系统](./007.md)

## 备注

- 战斗系统是游戏核心体验的关键
- 需要与UI系统紧密配合显示伤害数字
- 音效和特效对战斗体验至关重要
- 预留接口支持后续技能系统扩展