<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTI-2D 虚拟摇杆组件</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'military': {
                            50: '#f6f7f4',
                            100: '#e9ebe4',
                            200: '#d4d7ca',
                            300: '#b6bca7',
                            400: '#95a082',
                            500: '#7a8564',
                            600: '#616b4f',
                            700: '#556B2F',
                            800: '#485a28',
                            900: '#3d4b22',
                        },
                        'cyber': {
                            50: '#f0fdff',
                            100: '#ccf7fe',
                            200: '#9aeffd',
                            300: '#58e1fa',
                            400: '#00CED1',
                            500: '#00b4b8',
                            600: '#039094',
                            700: '#0a7377',
                            800: '#115e61',
                            900: '#134e52',
                        },
                        'tactical': {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#2F4F4F',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .joystick-container {
            position: relative;
            touch-action: none;
            user-select: none;
        }

        .joystick-base {
            transition: all 0.2s ease;
            background: radial-gradient(circle at 30% 30%, rgba(0, 206, 209, 0.3), rgba(47, 79, 79, 0.8));
            border: 2px solid rgba(0, 206, 209, 0.6);
            box-shadow:
                inset 0 0 20px rgba(0, 206, 209, 0.2),
                0 0 30px rgba(0, 206, 209, 0.3),
                0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .joystick-base.active {
            border-color: #00CED1;
            box-shadow:
                inset 0 0 25px rgba(0, 206, 209, 0.3),
                0 0 40px rgba(0, 206, 209, 0.5),
                0 2px 15px rgba(0, 0, 0, 0.4);
        }

        .joystick-knob {
            transition: all 0.1s ease;
            background: radial-gradient(circle at 30% 30%, #00CED1, #0a7377);
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow:
                inset 0 0 15px rgba(255, 255, 255, 0.2),
                0 0 20px rgba(0, 206, 209, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.4);
            position: absolute;
            cursor: grab;
        }

        .joystick-knob.dragging {
            cursor: grabbing;
            transform: scale(1.1);
            box-shadow:
                inset 0 0 20px rgba(255, 255, 255, 0.3),
                0 0 30px rgba(0, 206, 209, 0.6),
                0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .joystick-direction-indicator {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom, rgba(0, 206, 209, 1), rgba(0, 206, 209, 0));
            transform-origin: bottom center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .joystick-direction-indicator.active {
            opacity: 1;
        }

        .joystick-deadzone {
            position: absolute;
            border: 1px solid rgba(85, 107, 47, 0.4);
            border-radius: 50%;
            background: rgba(85, 107, 47, 0.1);
        }

        .joystick-boundary {
            position: absolute;
            border: 1px dashed rgba(0, 206, 209, 0.3);
            border-radius: 50%;
            pointer-events: none;
        }

        .joystick-info {
            font-family: 'Courier New', monospace;
            color: #00CED1;
            text-shadow: 0 0 5px rgba(0, 206, 209, 0.5);
            backdrop-filter: blur(5px);
            background: rgba(47, 79, 79, 0.8);
            border: 1px solid rgba(0, 206, 209, 0.3);
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 206, 209, 0.6);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* 触摸反馈涟漪效果 */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 206, 209, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-tactical-900 p-8 min-h-screen">
    <div class="max-w-6xl mx-auto">
        <!-- 页面标题 -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-cyber-400 mb-4">虚拟摇杆组件</h1>
            <p class="text-tactical-300">GTI-2D 游戏专用虚拟摇杆，支持拖拽、回弹动画和方向计算</p>
        </div>

        <!-- 演示区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 标准摇杆 -->
            <div class="bg-tactical-800 rounded-lg p-6 border border-tactical-600">
                <h3 class="text-xl font-bold text-cyber-400 mb-4">标准摇杆</h3>
                <div class="flex flex-col items-center space-y-4">
                    <div class="virtual-joystick" id="joystick1" data-size="120" data-sensitivity="1"></div>
                    <div class="joystick-info rounded-lg px-4 py-2 text-sm">
                        <div>角度: <span id="angle1" class="text-cyber-300">0°</span></div>
                        <div>强度: <span id="strength1" class="text-cyber-300">0.00</span></div>
                        <div>方向: <span id="direction1" class="text-cyber-300">静止</span></div>
                    </div>
                </div>
            </div>

            <!-- 大型摇杆 -->
            <div class="bg-tactical-800 rounded-lg p-6 border border-tactical-600">
                <h3 class="text-xl font-bold text-cyber-400 mb-4">大型摇杆</h3>
                <div class="flex flex-col items-center space-y-4">
                    <div class="virtual-joystick" id="joystick2" data-size="160" data-sensitivity="0.8"></div>
                    <div class="joystick-info rounded-lg px-4 py-2 text-sm">
                        <div>角度: <span id="angle2" class="text-cyber-300">0°</span></div>
                        <div>强度: <span id="strength2" class="text-cyber-300">0.00</span></div>
                        <div>方向: <span id="direction2" class="text-cyber-300">静止</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 小型摇杆演示 -->
        <div class="bg-tactical-800 rounded-lg p-6 border border-tactical-600 mb-8">
            <h3 class="text-xl font-bold text-cyber-400 mb-4">不同尺寸演示</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div class="flex flex-col items-center space-y-2">
                    <div class="text-sm text-tactical-300">小型 (80px)</div>
                    <div class="virtual-joystick" data-size="80" data-sensitivity="1.2"></div>
                </div>
                <div class="flex flex-col items-center space-y-2">
                    <div class="text-sm text-tactical-300">标准 (120px)</div>
                    <div class="virtual-joystick" data-size="120" data-sensitivity="1"></div>
                </div>
                <div class="flex flex-col items-center space-y-2">
                    <div class="text-sm text-tactical-300">大型 (160px)</div>
                    <div class="virtual-joystick" data-size="160" data-sensitivity="0.8"></div>
                </div>
                <div class="flex flex-col items-center space-y-2">
                    <div class="text-sm text-tactical-300">特大 (200px)</div>
                    <div class="virtual-joystick" data-size="200" data-sensitivity="0.6"></div>
                </div>
            </div>
        </div>

        <!-- API 使用示例 -->
        <div class="bg-tactical-800 rounded-lg p-6 border border-tactical-600 mb-8">
            <h3 class="text-xl font-bold text-cyber-400 mb-4">使用示例</h3>
            <pre class="bg-tactical-900 rounded p-4 text-cyber-300 text-sm overflow-x-auto"><code>// 创建摇杆实例
const joystick = new VirtualJoystick('container-id', {
    size: 120,              // 摇杆大小
    sensitivity: 1.0,       // 灵敏度 (0.1 - 2.0)
    deadzone: 0.1,         // 死区大小 (0.0 - 0.5)
    showDeadzone: true,    // 显示死区
    showBoundary: true,    // 显示边界
    enableHaptic: true,    // 触觉反馈
    onMove: (data) => {    // 移动回调
        console.log('角度:', data.angle);
        console.log('强度:', data.strength);
        console.log('方向:', data.direction);
    }
});

// 监听摇杆事件
joystick.on('move', (data) => {
    // 处理摇杆移动
    player.move(data.angle, data.strength);
});

joystick.on('start', () => {
    // 开始拖拽
    console.log('摇杆激活');
});

joystick.on('end', () => {
    // 结束拖拽
    console.log('摇杆释放');
});

// 程序化控制
joystick.setPosition(45, 0.5);  // 设置角度和强度
joystick.reset();               // 重置到中心
joystick.enable();              // 启用
joystick.disable();             // 禁用</code></pre>
        </div>

        <!-- 配置选项 -->
        <div class="bg-tactical-800 rounded-lg p-6 border border-tactical-600">
            <h3 class="text-xl font-bold text-cyber-400 mb-4">配置选项</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-semibold text-cyber-300 mb-2">基础配置</h4>
                    <ul class="space-y-2 text-tactical-300 text-sm">
                        <li><code class="text-cyber-400">size</code>: 摇杆大小 (60-300px)</li>
                        <li><code class="text-cyber-400">sensitivity</code>: 灵敏度 (0.1-2.0)</li>
                        <li><code class="text-cyber-400">deadzone</code>: 死区大小 (0.0-0.5)</li>
                        <li><code class="text-cyber-400">snapback</code>: 回弹速度 (100-1000ms)</li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-cyber-300 mb-2">视觉选项</h4>
                    <ul class="space-y-2 text-tactical-300 text-sm">
                        <li><code class="text-cyber-400">showDeadzone</code>: 显示死区</li>
                        <li><code class="text-cyber-400">showBoundary</code>: 显示边界</li>
                        <li><code class="text-cyber-400">showDirection</code>: 显示方向指示</li>
                        <li><code class="text-cyber-400">enableRipple</code>: 触摸涟漪效果</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * VirtualJoystick - 虚拟摇杆组件
         */
        class VirtualJoystick {
            constructor(containerId, options = {}) {
                this.container = typeof containerId === 'string' ? document.getElementById(containerId) : containerId;
                if (!this.container) {
                    throw new Error('Container not found');
                }

                // 默认配置
                this.config = {
                    size: 120,
                    sensitivity: 1.0,
                    deadzone: 0.1,
                    snapback: 300,
                    showDeadzone: true,
                    showBoundary: true,
                    showDirection: true,
                    enableHaptic: true,
                    enableRipple: true,
                    ...options
                };

                // 状态
                this.state = {
                    isDragging: false,
                    startPos: { x: 0, y: 0 },
                    currentPos: { x: 0, y: 0 },
                    angle: 0,
                    strength: 0,
                    direction: 'center'
                };

                // 事件监听器
                this.listeners = {};

                this.init();
            }

            init() {
                this.createElements();
                this.bindEvents();
                this.updateVisuals();
            }

            createElements() {
                const size = this.config.size;
                const knobSize = size * 0.4;
                const centerX = size / 2;
                const centerY = size / 2;

                this.container.innerHTML = `
                    <div class="joystick-container" style="width: ${size}px; height: ${size}px;">
                        <!-- 边界指示器 -->
                        ${this.config.showBoundary ? `
                            <div class="joystick-boundary"
                                 style="width: ${size}px; height: ${size}px; top: 0; left: 0;"></div>
                        ` : ''}

                        <!-- 死区指示器 -->
                        ${this.config.showDeadzone ? `
                            <div class="joystick-deadzone"
                                 style="width: ${size * this.config.deadzone * 2}px;
                                        height: ${size * this.config.deadzone * 2}px;
                                        top: ${centerY - size * this.config.deadzone}px;
                                        left: ${centerX - size * this.config.deadzone}px;"></div>
                        ` : ''}

                        <!-- 摇杆底座 -->
                        <div class="joystick-base rounded-full"
                             style="width: ${size}px; height: ${size}px;"></div>

                        <!-- 方向指示器 -->
                        ${this.config.showDirection ? `
                            <div class="joystick-direction-indicator"
                                 style="height: ${size * 0.3}px;
                                        left: ${centerX - 1}px;
                                        top: ${centerY - size * 0.3}px;"></div>
                        ` : ''}

                        <!-- 摇杆手柄 -->
                        <div class="joystick-knob rounded-full"
                             style="width: ${knobSize}px;
                                    height: ${knobSize}px;
                                    left: ${centerX - knobSize/2}px;
                                    top: ${centerY - knobSize/2}px;"></div>
                    </div>
                `;

                this.elements = {
                    container: this.container.querySelector('.joystick-container'),
                    base: this.container.querySelector('.joystick-base'),
                    knob: this.container.querySelector('.joystick-knob'),
                    direction: this.container.querySelector('.joystick-direction-indicator')
                };

                this.centerX = centerX;
                this.centerY = centerY;
                this.maxDistance = size / 2 - knobSize / 2;
            }

            bindEvents() {
                const knob = this.elements.knob;

                // 鼠标事件
                knob.addEventListener('mousedown', this.handleStart.bind(this));
                document.addEventListener('mousemove', this.handleMove.bind(this));
                document.addEventListener('mouseup', this.handleEnd.bind(this));

                // 触摸事件
                knob.addEventListener('touchstart', this.handleStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleEnd.bind(this));

                // 防止右键菜单
                knob.addEventListener('contextmenu', (e) => e.preventDefault());
            }

            handleStart(e) {
                e.preventDefault();

                this.state.isDragging = true;
                this.elements.base.classList.add('active');
                this.elements.knob.classList.add('dragging');

                if (this.config.enableRipple) {
                    this.createRipple(e);
                }

                this.emit('start', this.getJoystickData());

                if (this.config.enableHaptic && navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            handleMove(e) {
                if (!this.state.isDragging) return;

                e.preventDefault();

                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                const rect = this.elements.container.getBoundingClientRect();
                const centerX = rect.left + this.centerX;
                const centerY = rect.top + this.centerY;

                let deltaX = clientX - centerX;
                let deltaY = clientY - centerY;

                // 应用灵敏度
                deltaX *= this.config.sensitivity;
                deltaY *= this.config.sensitivity;

                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const angle = Math.atan2(-deltaY, deltaX) * 180 / Math.PI;

                // 限制在边界内
                if (distance > this.maxDistance) {
                    const ratio = this.maxDistance / distance;
                    deltaX *= ratio;
                    deltaY *= ratio;
                }

                // 更新手柄位置
                this.elements.knob.style.left = (this.centerX + deltaX - this.elements.knob.offsetWidth/2) + 'px';
                this.elements.knob.style.top = (this.centerY + deltaY - this.elements.knob.offsetHeight/2) + 'px';

                // 计算数值
                const strength = Math.min(distance / this.maxDistance, 1);
                const normalizedAngle = (angle + 360) % 360;

                this.state.angle = normalizedAngle;
                this.state.strength = strength;
                this.state.direction = this.getDirectionFromAngle(normalizedAngle);

                // 更新方向指示器
                if (this.elements.direction && strength > this.config.deadzone) {
                    this.elements.direction.classList.add('active');
                    this.elements.direction.style.transform = `rotate(${normalizedAngle - 90}deg)`;
                } else if (this.elements.direction) {
                    this.elements.direction.classList.remove('active');
                }

                this.emit('move', this.getJoystickData());
            }

            handleEnd(e) {
                if (!this.state.isDragging) return;

                this.state.isDragging = false;
                this.elements.base.classList.remove('active');
                this.elements.knob.classList.remove('dragging');

                if (this.elements.direction) {
                    this.elements.direction.classList.remove('active');
                }

                // 回弹动画
                this.snapToCenter();

                this.emit('end', this.getJoystickData());
            }

            snapToCenter() {
                this.elements.knob.style.transition = `all ${this.config.snapback}ms ease-out`;
                this.elements.knob.style.left = (this.centerX - this.elements.knob.offsetWidth/2) + 'px';
                this.elements.knob.style.top = (this.centerY - this.elements.knob.offsetHeight/2) + 'px';

                setTimeout(() => {
                    this.elements.knob.style.transition = 'all 0.1s ease';
                }, this.config.snapback);

                this.state.angle = 0;
                this.state.strength = 0;
                this.state.direction = 'center';

                this.emit('reset', this.getJoystickData());
            }

            createRipple(e) {
                const ripple = document.createElement('div');
                ripple.classList.add('ripple');

                const rect = this.elements.knob.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);

                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = '50%';
                ripple.style.top = '50%';
                ripple.style.transform = 'translate(-50%, -50%) scale(0)';

                this.elements.knob.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 600);
            }

            getDirectionFromAngle(angle) {
                const directions = ['右', '右下', '下', '左下', '左', '左上', '上', '右上'];
                const index = Math.round(angle / 45) % 8;
                return directions[index];
            }

            getJoystickData() {
                const strength = this.state.strength > this.config.deadzone ? this.state.strength : 0;
                return {
                    angle: this.state.angle,
                    strength: strength,
                    direction: strength > 0 ? this.state.direction : '静止',
                    x: Math.cos(this.state.angle * Math.PI / 180) * strength,
                    y: -Math.sin(this.state.angle * Math.PI / 180) * strength
                };
            }

            // 事件系统
            on(event, callback) {
                if (!this.listeners[event]) {
                    this.listeners[event] = [];
                }
                this.listeners[event].push(callback);
            }

            off(event, callback) {
                if (this.listeners[event]) {
                    this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
                }
            }

            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
            }

            // 公共API
            setPosition(angle, strength) {
                if (this.state.isDragging) return;

                const radians = angle * Math.PI / 180;
                const distance = Math.min(strength, 1) * this.maxDistance;

                const deltaX = Math.cos(radians) * distance;
                const deltaY = -Math.sin(radians) * distance;

                this.elements.knob.style.left = (this.centerX + deltaX - this.elements.knob.offsetWidth/2) + 'px';
                this.elements.knob.style.top = (this.centerY + deltaY - this.elements.knob.offsetHeight/2) + 'px';

                this.state.angle = angle;
                this.state.strength = strength;
                this.state.direction = this.getDirectionFromAngle(angle);
            }

            reset() {
                this.snapToCenter();
            }

            updateVisuals() {
                // 可以用于更新主题等
            }
        }

        // 初始化演示摇杆
        document.addEventListener('DOMContentLoaded', () => {
            // 为每个摇杆容器创建实例
            document.querySelectorAll('.virtual-joystick').forEach((container, index) => {
                const size = parseInt(container.dataset.size) || 120;
                const sensitivity = parseFloat(container.dataset.sensitivity) || 1.0;

                const joystick = new VirtualJoystick(container, {
                    size: size,
                    sensitivity: sensitivity,
                    deadzone: 0.15,
                    showDeadzone: size >= 120,
                    showBoundary: size >= 120,
                    showDirection: size >= 120
                });

                // 为前两个摇杆绑定信息显示
                if (index < 2) {
                    const joystickId = index + 1;
                    const angleEl = document.getElementById(`angle${joystickId}`);
                    const strengthEl = document.getElementById(`strength${joystickId}`);
                    const directionEl = document.getElementById(`direction${joystickId}`);

                    joystick.on('move', (data) => {
                        if (angleEl) angleEl.textContent = Math.round(data.angle) + '°';
                        if (strengthEl) strengthEl.textContent = data.strength.toFixed(2);
                        if (directionEl) directionEl.textContent = data.direction;
                    });

                    joystick.on('reset', (data) => {
                        if (angleEl) angleEl.textContent = '0°';
                        if (strengthEl) strengthEl.textContent = '0.00';
                        if (directionEl) directionEl.textContent = '静止';
                    });
                }
            });
        });
    </script>
</body>
</html>